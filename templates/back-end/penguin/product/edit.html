{include file="$include_tpl/includes/head.html"}
	<!--sidebar-->
	{include file="$include_tpl/includes/sidebar.html"}
	<!--/sidebar-->
	<!--Page Container-->
	<section class="main-container">	
            
        <!--Page Header-->
			<div class="header">
				<div class="header-content">
					<div class="page-title">
						<i class="icon-table position-left"></i> {$title}
					</div>
					<ul class="breadcrumb">
						<li><a href="{$adminweburl}">Beranda</a></li>
						<li><a href="{$adminweburl}/dashboard/">{$title}</a></li>
						<li class="active">{$sub_title}</li>
					</ul>					
				</div>
			</div>		
			<!--/Page Header-->
			
			<div class="container-fluid page-content">				
				<div class="row">
					<div class="col-md-12">
						<div class="panel panel-flat">
                            <div class="panel-heading">
                                <h3 class="panel-title"><strong>{$title}</strong></h3>				
                                <h5 class="panel-title">{$sub_title}</h5>				
                            </div>

                            <div class="panel-body">
                                <div id="wrapper" class="row" style="margin: 5px;">  
                                    <!---- BUKA ---->        
                                    <div class="form-group"> </div>
                                                    
                                    <div id="alert_error" class="form-group" style="display: none;">
                                        <div class="alert alert-danger">&nbsp;</div>
                                    </div>
                                
                                    <div class="form-group">
                                        <label class="control-label">Mitra:</label>
                                        <select id="mitra" name="mitra" class="form-control">
                                            <option value="0">-- Pilih Mitra --</option>
                                            {foreach $listmitra as $entry}
                                            <option value="{$entry.id}" {if $entry.id eq $data[0].id_member} selected="selected" {/if}>{$entry.nama}</option>
                                            {/foreach}
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="kode">Kode Produk:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].kode}{/if}" class="form-control" name="kode" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="nama">Nama Produk:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].nama}{/if}" class="form-control" name="nama" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="penjelasan">Penjelasan Produk:</label>
                                        <div class="summernote"></div>
                                    </div>

                                    <div class="form-group">
                                        <label for="satuan">Satuan:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].satuan}{/if}" class="form-control" name="satuan" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="harga_jual_umum">Harga Per Satuan:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].harga_jual}{else}0{/if}" class="form-control harga" name="harga_jual_umum" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="minimum_pesan">Minimum Pesan:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].minimum_pesan}{else}1{/if}" class="form-control harga" name="minimum_pesan" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="harga_diskon">Harga Promo:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].harga_diskon}{else}0{/if}" class="form-control harga" name="harga_diskon" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="from_date_harga_diskon">Tanggal Harga Promo Dari:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].from_date_harga_diskon}{/if}" class="form-control tanggal" name="from_date_harga_diskon" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="to_date_harga_diskon">Tanggal Harga Promo Sampai:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].to_date_harga_diskon}{/if}" class="form-control tanggal" name="to_date_harga_diskon" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="persen_diskon">Diskon Promo:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].persen_diskon}{else}0{/if}" class="form-control" name="persen_diskon" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="from_date_persen_diskon">Tanggal Diskon Promo Dari:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].from_date_persen_diskon}{/if}" class="form-control tanggal" name="from_date_persen_diskon" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="to_date_persen_diskon">Tanggal Diskon Promo Sampai:</label>
                                        <input type="text" value="{if $isEdit eq true}{$data[0].to_date_persen_diskon}{/if}" class="form-control tanggal" name="to_date_persen_diskon" placeholder="" />
                                    </div>

                                    <div class="form-group">
                                        <label for="photo">Foto Produk:</label>
                                        <input type="file" id="fileupload_foto_1" name="fileupload_foto_1" multiple />
                                    </div>

                                    {for $foo=1 to 20}
                                        {assign var="no" value=$foo-1}
                                        <div class="form-group">
                                            <img id="preview_foto_{$foo}" src="{if $listfoto[$no].nama_file neq ''}{$homeurl}/uploads/produk/{$listfoto[$no].nama_file}{else}#{/if}" style="height: 300px;{if $listfoto[$no].nama_file eq ''}display: none;{/if}" alt="{$foo}" />
                                            <div id="blok_hapus_{$foo}" style="margin-top: 5px;{if $listfoto[$no].nama_file eq ''}display: none;{/if}">
                                                <div id_hapus_foto="{$foo}" class="btn btn btn-danger hapus_foto">Hapus</div>
                                                <label class="control-label"><input type="checkbox" id="gambar_utama_{$foo}" id_gambar_utama="{$foo}" class="pilih_gambar_utama" {if $listfoto[$no].as_default eq 'Y'}checked{/if} /> Atur sebagai gambar utama.</label>
                                            </div>
                                        </div>
                                    {/for}
                                    
                                    <div class="form-group">
                                        <label for="status">Status Produk:</label>
                                        <select class="form-control" name="status">
                                            <option value="1" {if $isEdit eq true && $data[0].status eq "1"} selected="selected" {/if}>Publish</option>
                                            <option value="0" {if $isEdit eq true && $data[0].status eq "0"} selected="selected" {/if}>Unpublish</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <table>
                                            <tbody>
                                                <tr>
                                                    <td width="100%">&nbsp;</td> 
                                                    <td nowrap>
                                                        <div id="i_loading" class="G-btn-animation" style="display: none;"><img src="{$tpl_dir}/assets/img/loading.gif" /></div>                  
                                                        <div id="btn_simpan" type="submit" class="btn btn-primary">Simpan</div>
                                                    </td>
                                                </tr>
                                            </tbody>                                
                                        </table>
                                    </div>
                                    <!---- TUTUP ---->	
                                </div>
                            </div>
                        </div>
                    </div>
                </div>		
		    </div>
	
		<!--Footer -->
		{include file="$include_tpl/includes/footer.html"}
		<!--/Footer-->
		
	</section>
	<!--/Page Container-->
    
    <a id="scrollTop" href="index1.htm#top"><i class="icon-arrow-up12"></i></a>	

<!-- Global scripts -->
<script src="{$tpl_dir}/js/jquery.js"></script>	
<script src="{$tpl_dir}/js/bootstrap.js"></script>
<script src="{$tpl_dir}/js/jquery.ui.js"></script>
<script src="{$tpl_dir}/js/nav.accordion.js"></script>	
<script src="{$tpl_dir}/js/hammerjs.js"></script>
<script src="{$tpl_dir}/js/jquery.hammer.js"></script>
<script src="{$tpl_dir}/js/scrollup.js"></script>	
<script src="{$tpl_dir}/js/jquery.slimscroll.js"></script>	
<script src="{$tpl_dir}/js/smart-resize.js"></script>
<script src="{$tpl_dir}/js/blockui.min.js"></script>		
<script src="{$tpl_dir}/js/wow.min.js"></script>					
<script src="{$tpl_dir}/js/fancybox.min.js"></script>
<script src="{$tpl_dir}/js/venobox.js"></script>
<script src="{$tpl_dir}/js/forms/uniform.min.js"></script>
<script src="{$tpl_dir}/js/forms/switchery.js"></script>
<script src="{$tpl_dir}/js/forms/select2.min.js"></script>	
<script src="{$tpl_dir}/js/core.js"></script>
<!-- /global scripts -->

<!-- Page scripts -->
<script src="{$tpl_dir}/assets/bootstrap-fileinput/js/fileinput.js"></script>
<script type="text/javascript" src="{$tpl_dir}/assets/js/jquery.input.formatter.js"></script>  

<!-- include summernote -->
<link rel="stylesheet" href="{$tpl_dir}/assets/dist/summernote.css">
<script type="text/javascript" src="{$tpl_dir}/assets/dist/summernote.js"></script>
<script type="text/javascript" src="{$tpl_dir}/assets/dist/summernote-ext-video.js"></script> 
<link href="{$tpl_dir}/assets/datepick/jquery.datepick.css" rel="stylesheet">
<script src="{$tpl_dir}/assets/datepick/jquery.plugin.js"></script>
<script src="{$tpl_dir}/assets/datepick/jquery.datepick.js"></script>


<script type="text/javascript">
            $(function () {           
	            $("input.harga").formatInput();

	            var isEdit = {if $isEdit eq true}true{else}false{/if};
	            $('.summernote').summernote({
	                height: 300,
	                toolbar: [
	                    ['style', ['style']],
	                    ['font', ['bold', 'italic', 'underline', 'clear']],
	                    //['fontname', ['fontname']],
	                    // ['fontsize', ['fontsize']], Still buggy
	                    ['color', ['color']],
	                    ['para', ['ul', 'ol', 'paragraph']],
	                    // ['height', ['height']],
	                    ['table', ['table']],
	                    ['insert', ['link', 'picture', 'video']],
	                    //['view', ['fullscreen' , 'codeview' ]],
	                    ['help', ['help']]
	                ]
	            });
	            
	            $(".summernote").code('{if $isEdit eq true}{$data[0].penjelasan}{/if}');

	            function setErrorMessage(message) {
	                $('#alert_error .alert').text(message);
	                $('#alert_error').show('slow');
	                setTimeout(function() {
	                    $('#alert_error').hide('slow');
	                }, 5000);
	                $("body, html").animate({ 
	                    scrollTop: $('#wrapper').offset().top - 70
	                }, 600);

	            }

	            $('#btn_simpan').click(function() {            
	                submitProduk();
	            });
	            
	            function submitProduk() {
	                var data = new FormData();
	                data.append('id', isEdit?'{$data[0].id}':'');
	                data.append('id_member', $('[name=mitra]').val());
	                data.append('kode', $('[name=kode]').val());
	                data.append('nama', $('[name=nama]').val());
	                data.append('penjelasan', $('.summernote').summernote().code().replace(/\n/, '<br />'));

	                data.append('satuan', $('[name=satuan]').val());
	                data.append('harga_jual', ($('[name=harga_jual_umum]').val()).replace(/\,/g, ''));
					
	                data.append('minimum_pesan', ($('[name=minimum_pesan]').val()).replace(/\,/g, ''));               
	                data.append('harga_diskon', ($('[name=harga_diskon]').val()).replace(/\,/g, ''));
	                data.append('from_date_harga_diskon', $('[name=from_date_harga_diskon]').val());
	                data.append('to_date_harga_diskon', $('[name=to_date_harga_diskon]').val());
	                data.append('persen_diskon', $('[name=persen_diskon]').val());
	                data.append('from_date_persen_diskon', $('[name=from_date_persen_diskon]').val());
	                data.append('to_date_persen_diskon', $('[name=to_date_persen_diskon]').val());
	                
	                for(var key in files) {
	                    data.append('filename_foto_'+(eval(key)+1), files[key]);
	                    /*if(files[key]!=undefined && typeof files[key] === 'object') {
	                        $.each(files[key], function(keys, value) {
	                            alert();
	                        });                        
	                    }*/
	                }

	                for(var i=0; i<20; i++) {
	                    if($('#gambar_utama_'+(i+1)).is(':checked')) {
	                        data.append('as_default', (i+1));
	                        //console.log('as_default: '+(i+1));
	                        //alert('as_default: '+(i+1));
	                        break;
	                    }
	                }
	                
	                var changes_data='';
	                for(var key in changes) {
	                    changes_data+=key+',';
	                }
	                //console.log(changes_data);
	                data.append('changes', changes_data);
	                data.append('status', $('[name=status]').val());

	                //setLoading(true);
	                try {
					    window.cpjs.showProgressDialog(true);
					} catch(err) {
					    console.log(err.message);
					}

	                $.ajax({
	                    type: 'POST',
	                    url: isEdit?'update.php':'save.php',
	                    data: data,
	                    cache: false,
	                    dataType: 'json',
	                    processData: false, // Don't process the files
	                    contentType: false, // Set content type to false as jQuery will tell the server its a query string request
	                    success: function(data) {
                            setLoading(false);
                            if(data['success']) {
                                swal('Sukses', 'Record Data Batal Disimpan', 'success')
                                window.location = 'list.php';                    
                            } else {
                                setErrorMessage(data['message']);                        
                            }
                        }, 

                        error: function() {
                            setLoading(false);
                            setErrorMessage('Proses simpan data produk gagal!');
                        }

	                });
	            }

	            function setLoading(isLoading) {
	                if(isLoading) {
	                    $('#i_loading').show();
	                    $('#btn_simpan').hide();
	                    $('#btn_batal').hide();
	                } else {
	                    $('#i_loading').hide();
	                    $('#btn_simpan').show(); 
	                    $('#btn_batal').show();
	                }
	            }

	            //FUNGSI GAMBAR
	            function readURL(input, id) {
	                if (input.files && input.files[id-1]) {
	                    var reader = new FileReader();
	                    reader.onload = function (e) {
	                        $('#preview_foto_'+id).attr('src', e.target.result);
	                        $("#fileupload_gambar").val(e.target.result);
	                    }
	                    reader.readAsDataURL(input.files[id-1]);
	                }
	            }

				var files = new Array();
	            {for $foo=1 to 20}
	                {assign var="no" value=$foo-1}
	                {if $listfoto[$no].nama_file neq ''}files[{$no}] = '{$listfoto[$no].nama_file}';{/if}
	            {/for}
	            
	            var changes = new Array();
	            $("#fileupload_foto_1").change(function(event) {
	                if(!event.target.files) return;
	                var f = event.target.files;
	                var len = f.length>20?20:f.length;
	                for(var i=0; i < len; i++) {
	                    readURL(this, i+1);
	                    files[i] = f[i];
	                    changes[i] = true;
	                    console.log('changes '+i+ ' '+changes[i]);
	                    $('#preview_foto_'+(i+1)).show();
	                    $('#blok_hapus_'+(i+1)).show();
	                }
	                for(var i=1; i<20; i++) {
	                    if($('#gambar_utama_'+(i+1)).is(':checked')) return;
	                }
	                $('#gambar_utama_1').prop('checked', true);
	            });

	            $('.hapus_foto').click(function() {
	                var id = this.getAttribute("id_hapus_foto");
	                files[eval(id)-1] = undefined;
	                changes[eval(id)-1] = true;                
	                $('#fileupload_foto_'+id).val('');
	                $('#preview_foto_'+id).hide();
	                $('#blok_hapus_'+id).hide();
	                if($('#gambar_utama_'+id).is(':checked')) {
	                    $('#gambar_utama_'+id).prop('checked', false);
	                    for(var i=0; i<20; i++) {
	                        if(files[i] != undefined) {
	                            $('#gambar_utama_'+(i+1)).prop('checked', true);    
	                            break;
	                        }
	                    }
	                }
	            });

	            $('.pilih_gambar_utama').click(function() {
	                var id = this.getAttribute("id_gambar_utama");
	                for(var i=0; i<20; i++) {
	                    $('#gambar_utama_'+(i+1)).prop('checked', id==i+1);
	                }
	            });
	        });
    </script>

</body>{include file="$include_tpl/includes/footer_js.html"}
</html>